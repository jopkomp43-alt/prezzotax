import React, { useState, useEffect, useRef, useMemo } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from 'firebase/auth';
import { getFirestore, collection, doc, addDoc, updateDoc, deleteDoc, onSnapshot, query, serverTimestamp } from 'firebase/firestore';
import { Layout, Plus, Package, Sparkles, TrendingUp, Trash2, Camera, ChevronRight, Save, Info, Upload, X, Loader2, CheckCircle2, AlertCircle, Image as ImageIcon, Copy, Eye, Edit3, Hash, MessageSquare, HelpCircle, Send, Star, Users, Zap, Globe2, Lock, BarChart3, Calendar, Flame } from 'lucide-react';

// --- Firebase & App Configuratie ---
const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
const appId = typeof __app_id !== 'undefined' ? __app_id : 'vinted-accelerator-v1';
const apiKey = ""; 

let app, auth, db;
if (firebaseConfig) {
  try {
    app = initializeApp(firebaseConfig);
    auth = getAuth(app);
    db = getFirestore(app);
  } catch (e) {
    console.error("Firebase initialization failed", e);
  }
}

// --- Logo Component ---
const PrezzotaxLogo = ({ size = 44, showText = true }) => (
  <div className="flex items-center gap-3 group shrink-0">
    <div 
      style={{ width: size, height: size }} 
      className="relative flex items-center justify-center rounded-full overflow-hidden border border-slate-200 bg-white shadow-md transition-transform group-hover:scale-105"
    >
      <svg viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg" className="w-full h-full">
        <circle cx="50" cy="50" r="50" fill="white"/>
        <path d="M30 68C21 68 14 61 14 52C14 43 21 36 30 36C31 36 32 36 33.5 36.5C37 28 45 23 54 23C65 23 74 31 75.5 41.5C76.5 41 78 41 79.5 41C87 41 93 47 93 54.5C93 62 87 68 79.5 68L30 68Z" fill="#1A314D" />
        <path d="M30 65C23 65 18 60 18 53C18 46 23 41 30 41C31 41 32 41 33 41.5C36 35 43 30 51 30C60 30 67 36 68.5 44.5C69.5 44 70.5 44 71.5 44C77.5 44 82 48.5 82 54.5C82 60.5 77.5 65 71.5 65L30 65Z" fill="#00B4D8" opacity="0.8" />
        <path d="M50 38C52 38 54 39.5 54 41.5C54 43 53 44 51.5 44.5L68 56C69 57 69 59 68 60.5C67 62 65 62 64 61L50 51L36 61C35 62 33 62 32 60.5C31 59 31 57 32 56L48.5 44.5C47 44 46 43 46 41.5C46 39.5 48 38 50 38Z" stroke="#FDBA74" strokeWidth="2.5" strokeLinecap="round" />
        <path d="M50 63V52M50 52L45 57M50 52L55 57" stroke="#22D3EE" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round" />
      </svg>
    </div>
    {showText && (
      <div className="flex flex-col text-left">
        <span className="font-black text-2xl tracking-tighter leading-none text-slate-900 uppercase italic">
          prezzo<span className="text-cyan-500">tax</span>
        </span>
        <span className="text-[7px] font-bold text-slate-400 uppercase tracking-[0.15em] mt-1 text-slate-400 uppercase tracking-widest leading-none">Your Style. Your Story.</span>
      </div>
    )}
  </div>
);

const compressImage = (base64Str, maxWidth = 800, maxHeight = 800) => {
  return new Promise((resolve) => {
    const img = new Image();
    img.src = base64Str;
    img.onload = () => {
      const canvas = document.createElement('canvas');
      let width = img.width; let height = img.height;
      if (width > height) { if (width > maxWidth) { height *= maxWidth / width; width = maxWidth; } }
      else { if (height > maxHeight) { width *= maxHeight / height; height = maxHeight; } }
      canvas.width = width; canvas.height = height;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0, width, height);
      resolve(canvas.toDataURL('image/jpeg', 0.7));
    };
    img.onerror = () => resolve(base64Str);
  });
};

const App = () => {
  const [user, setUser] = useState(null);
  const [inventory, setInventory] = useState([]);
  const [messages, setMessages] = useState([]);
  const [isAdding, setIsAdding] = useState(false);
  const [viewMode, setViewMode] = useState('edit'); 
  const [loading, setLoading] = useState(false);
  const [initializing, setInitializing] = useState(true);
  const [saveStatus, setSaveStatus] = useState('idle'); 
  const [activeTab, setActiveTab] = useState('overzicht');
  const [communityTab, setCommunityTab] = useState('chat');
  const [newMessage, setNewMessage] = useState('');
  const [selectedItem, setSelectedItem] = useState(null);
  const fileInputRef = useRef(null);

  const [formData, setFormData] = useState({
    title: '', category: 'Kleding', brand: '', size: '', color: '', material: '',
    condition: 'Heel goed', targetPrice: '', description_nl: '', description_en: '',
    description_fr: '', hashtags: '', images: [], aiSuggestions: null
  });

  // --- Mock Data voor Jaaroverzicht Trends (Publiek) ---
  const seasonalTrends = [
    { month: 'Januari', items: 'Wintersport & Fitness kleding', trend: 'Piek' },
    { month: 'Februari', items: 'Luxe Merken & Tassen', trend: 'Stabiel' },
    { month: 'Maart', items: 'Lentejassen & Sneakers', trend: 'Stijgend' },
    { month: 'April', items: 'Jurken & Blazers', trend: 'Piek' },
    { month: 'Mei', items: 'Zomerjurkjes & Sandalen', trend: 'Stijgend' },
    { month: 'Juni', items: 'Zwemkleding & Korte broeken', trend: 'Maximaal' },
    { month: 'Juli', items: 'Festivalkleding & Zonnebrillen', trend: 'Maximaal' },
    { month: 'Augustus', items: 'Back-to-school Rugzakken', trend: 'Stijgend' },
    { month: 'September', items: 'Truien & Cardigans', trend: 'Piek' },
    { month: 'Oktober', items: 'Regenjassen & Boots', trend: 'Piek' },
    { month: 'November', items: 'Dikke Winterjassen', trend: 'Maximaal' },
    { month: 'December', items: 'Glitters & Feestkleding', trend: 'Piek' }
  ];

  // --- Berekende Privé Statistieken ---
  const myStats = useMemo(() => {
    const total = inventory.length;
    const value = inventory.reduce((acc, curr) => acc + (parseFloat(curr.targetPrice) || 0), 0);
    const avgPrice = total > 0 ? (value / total).toFixed(2) : 0;
    
    const categories = inventory.reduce((acc, curr) => {
      acc[curr.category] = (acc[curr.category] || 0) + 1;
      return acc;
    }, {});

    return { total, value, avgPrice, categories };
  }, [inventory]);

  useEffect(() => {
    document.title = "Prezzotax - Vinted Accelerator";
  }, []);

  useEffect(() => {
    if (!auth) { setInitializing(false); return; }
    const initAuth = async () => {
      try {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
          await signInWithCustomToken(auth, __initial_auth_token);
        } else {
          await signInAnonymously(auth);
        }
      } catch (e) { console.error("Auth error", e); }
      finally { setInitializing(false); }
    };
    initAuth();
    const unsubscribe = onAuthStateChanged(auth, (u) => setUser(u));
    return () => unsubscribe();
  }, []);

  useEffect(() => {
    if (!user || !db) return;
    const qInv = collection(db, 'artifacts', appId, 'users', user.uid, 'inventory');
    const unsubInv = onSnapshot(qInv, (snapshot) => {
      const items = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      setInventory(items.sort((a, b) => new Date(b.updatedAt || 0) - new Date(a.updatedAt || 0)));
    });

    const qMsg = collection(db, 'artifacts', appId, 'public', 'data', 'messages');
    const unsubMsg = onSnapshot(qMsg, (snapshot) => {
      const msgs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      setMessages(msgs.sort((a, b) => (a.createdAt?.seconds || 0) - (b.createdAt?.seconds || 0)));
    });

    return () => { unsubInv(); unsubMsg(); };
  }, [user]);

  const handleImageChange = async (e) => {
    const files = Array.from(e.target.files);
    if (files.length === 0) return;
    setLoading(true);
    try {
      const allProcessedImages = [];
      for (let file of files) {
        const reader = new FileReader();
        const fileData = await new Promise((res) => {
          reader.onloadend = () => res(reader.result);
          reader.readAsDataURL(file);
        });
        const compressed = await compressImage(fileData);
        allProcessedImages.push(compressed);
      }
      setFormData(prev => ({ ...prev, images: [...prev.images, ...allProcessedImages] }));
      if (allProcessedImages.length > 0) await analyzeFirstImage(allProcessedImages[0]);
    } catch (err) { console.error(err); } finally { setLoading(false); }
  };

  const analyzeFirstImage = async (base64Image) => {
    if (!base64Image) return;
    setLoading(true);
    const mimeType = base64Image.split(';')[0].split(':')[1] || "image/jpeg";
    const base64Data = base64Image.split(',')[1];
    const prompt = `Analyseer deze foto voor Prezzotax. Genereer verkoopgegevens in NL, EN en FR voor Vinted. REGELS: 1. Maat in TITEL. 2. Merkloos? brand leeg. 3. 15 hashtags. JSON format: {"title": "...", "brand": "...", "size": "...", "color": "...", "material": "...", "category": "...", "condition": "...", "description_nl": "...", "description_en": "...", "description_fr": "...", "hashtags": "#tag1...", "suggestedPrice": 0.00}`;
    try {
      const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ contents: [{ role: "user", parts: [{ text: prompt }, { inlineData: { mimeType, data: base64Data } }] }] })
      });
      const result = await response.json();
      const ai = JSON.parse(result.candidates[0].content.parts[0].text.replace(/```json/g, '').replace(/```/g, '').trim());
      setFormData(prev => ({ ...prev, ...ai, targetPrice: ai.suggestedPrice.toString(), aiSuggestions: ai }));
    } catch (e) { console.error(e); } finally { setLoading(false); }
  };

  const sendMessage = async (isImportant = false) => {
    if (!newMessage.trim() || !user || !db) return;
    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'messages'), {
      text: newMessage, userId: user.uid, userName: user.uid.substring(0, 5), createdAt: serverTimestamp(), isImportant
    });
    setNewMessage('');
  };

  const handleSave = async () => {
    if (!user || !db) return;
    setSaveStatus('saving');
    try {
      const payload = { ...formData, userId: user.uid, updatedAt: new Date().toISOString() };
      if (selectedItem) await updateDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'inventory', selectedItem.id), payload);
      else await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'inventory'), payload);
      setSaveStatus('success');
      setTimeout(() => { setIsAdding(false); setSelectedItem(null); setSaveStatus('idle'); resetForm(); setActiveTab('magazijn'); }, 1000);
    } catch (e) { setSaveStatus('error'); }
  };

  const resetForm = () => {
    setFormData({ title: '', category: 'Kleding', brand: '', size: '', color: '', material: '', condition: 'Heel goed', targetPrice: '', description_nl: '', description_en: '', description_fr: '', hashtags: '', images: [], aiSuggestions: null });
  };

  const copyText = (text) => {
    const el = document.createElement('textarea'); el.value = text;
    document.body.appendChild(el); el.select(); document.execCommand('copy'); document.body.removeChild(el);
  };

  const getFullDescription = () => {
    return `[NEDERLANDS]\n${formData.description_nl}\n\n[ENGLISH]\n${formData.description_en}\n\n[FRANÇAIS]\n${formData.description_fr}\n\n${formData.hashtags}`;
  };

  const removeImage = (index) => {
    setFormData(prev => ({ ...prev, images: prev.images.filter((_, i) => i !== index) }));
  };

  if (initializing) return (
    <div className="h-screen flex items-center justify-center bg-[#1A314D] animate-pulse"><PrezzotaxLogo size={120} showText={false} /></div>
  );

  return (
    <div className="min-h-screen bg-slate-50 text-slate-900 font-sans pb-32">
      <header className="bg-white/90 backdrop-blur-md border-b border-slate-200 sticky top-0 z-40">
        <div className="max-w-6xl mx-auto px-6 h-24 flex items-center justify-between">
          <PrezzotaxLogo />
          <button onClick={() => { setIsAdding(true); setViewMode('edit'); resetForm(); }} className="bg-[#1A314D] text-white px-6 py-3 rounded-2xl font-black flex items-center gap-2 active:scale-95 transition-all shadow-lg hover:bg-slate-800">
            <Plus size={24} className="text-cyan-400" /> <span className="hidden sm:inline">Item Toevoegen</span>
          </button>
        </div>
      </header>

      <main className="max-w-6xl mx-auto px-6 py-10">
        {activeTab === 'overzicht' && (
          <div className="space-y-16 animate-in fade-in duration-700">
             {/* Privé Stats - Bovenste rij */}
             <div className="space-y-6">
                <div className="flex items-center gap-3">
                   <Lock size={18} className="text-emerald-500" />
                   <h2 className="text-xl font-black uppercase tracking-widest italic text-slate-400">Jouw Privé Statistieken</h2>
                </div>
                <div className="grid grid-cols-1 md:grid-cols-3 gap-8">
                  <div className="bg-white p-10 rounded-[3rem] border border-slate-100 shadow-sm relative overflow-hidden">
                     <div className="text-slate-400 text-[10px] font-black uppercase mb-4 tracking-widest">Totale Waarde</div>
                     <div className="text-5xl font-black text-emerald-600">€{myStats.value.toFixed(0)}</div>
                     <BarChart3 className="absolute -bottom-4 -right-4 text-emerald-50" size={100} />
                  </div>
                  <div className="bg-white p-10 rounded-[3rem] border border-slate-100 shadow-sm">
                     <div className="text-slate-400 text-[10px] font-black uppercase mb-4 tracking-widest">Actieve Items</div>
                     <div className="text-5xl font-black text-[#1A314D]">{myStats.total}</div>
                  </div>
                  <div className="bg-[#1A314D] p-10 rounded-[3rem] text-white flex items-center justify-between relative overflow-hidden">
                    <div className="relative z-10">
                      <div className="text-cyan-400 text-[10px] font-black uppercase mb-4 tracking-widest">Gem. Prijs</div>
                      <div className="text-4xl font-black italic">€{myStats.avgPrice}</div>
                    </div>
                    <Sparkles size={80} className="absolute -right-4 opacity-20 rotate-12" />
                  </div>
                </div>
             </div>

             {/* Welkomstsectie / Filosofie */}
             <div className="bg-slate-900 rounded-[4rem] p-12 text-white shadow-2xl relative overflow-hidden text-center md:text-left">
                <div className="absolute top-0 right-0 w-96 h-96 bg-cyan-500/10 rounded-full blur-3xl -mr-32 -mt-32"></div>
                <div className="flex flex-col md:flex-row items-center gap-10 relative z-10">
                   <div className="p-6 bg-white/5 rounded-full backdrop-blur-md shrink-0 border border-white/10 shadow-2xl">
                      <PrezzotaxLogo size={140} showText={false} />
                   </div>
                   <div className="flex-1">
                      <h1 className="text-5xl font-black italic uppercase tracking-tighter mb-4 leading-none">Groeien Zonder Geheimen</h1>
                      <p className="text-xl text-slate-300 font-medium max-w-2xl leading-relaxed mb-8">
                         Prezzotax is de hub voor serieuze verkopers. Jouw voorraad is privé, maar onze kennis is openbaar. De markt is groot genoeg voor iedereen!
                      </p>
                      <div className="flex flex-wrap justify-center md:justify-start gap-4">
                         <button onClick={() => setIsAdding(true)} className="bg-cyan-500 text-slate-900 px-10 py-5 rounded-[2rem] font-black hover:bg-cyan-400 transition-all flex items-center gap-2 shadow-xl shadow-cyan-500/20 active:scale-95">Maak Product <ChevronRight size={24} /></button>
                         <button onClick={() => setActiveTab('info')} className="bg-white/5 border border-white/10 text-white px-10 py-5 rounded-[2rem] font-black hover:bg-white/10 transition-all">Bekijk Trends</button>
                      </div>
                   </div>
                </div>
             </div>

             {/* Stappenplan */}
             <div className="grid grid-cols-1 md:grid-cols-3 gap-10">
                <div className="bg-white p-10 rounded-[3.5rem] border border-slate-100 shadow-sm text-center space-y-6 group">
                   <div className="w-20 h-20 bg-cyan-50 rounded-3xl flex items-center justify-center text-cyan-500 mx-auto group-hover:rotate-6 transition-transform"><Camera size={40} /></div>
                   <h3 className="text-2xl font-black italic uppercase text-[#1A314D]">1. Snap It</h3>
                   <p className="text-slate-500 leading-relaxed text-sm">Upload foto's veilig in je eigen kluis. Alleen jij ziet wat je in de kast hebt.</p>
                </div>
                <div className="bg-white p-10 rounded-[3.5rem] border border-slate-100 shadow-sm text-center space-y-6 group">
                   <div className="w-20 h-20 bg-indigo-50 rounded-3xl flex items-center justify-center text-indigo-500 mx-auto group-hover:rotate-6 transition-transform"><Zap size={40} /></div>
                   <h3 className="text-2xl font-black italic uppercase text-[#1A314D]">2. AI Magic</h3>
                   <p className="text-slate-500 leading-relaxed text-sm">Prezzotax schrijft automatisch listings in NL, EN en FR voor de hele Europese markt.</p>
                </div>
                <div className="bg-white p-10 rounded-[3.5rem] border border-slate-100 shadow-sm text-center space-y-6 group">
                   <div className="w-20 h-20 bg-emerald-50 rounded-3xl flex items-center justify-center text-emerald-500 mx-auto group-hover:rotate-6 transition-transform"><Copy size={40} /></div>
                   <h3 className="text-2xl font-black italic uppercase text-[#1A314D]">3. Sell Fast</h3>
                   <p className="text-slate-500 leading-relaxed text-sm">Gebruik de beste hashtags en teksten. Geen geheimen, gewoon resultaat.</p>
                </div>
             </div>
          </div>
        )}

        {activeTab === 'magazijn' && (
          <div className="space-y-10 animate-in slide-in-from-bottom-10 duration-500 text-left">
            <div className="flex items-center justify-between">
               <h2 className="text-4xl font-black flex items-center gap-5 italic text-[#1A314D] uppercase"><Package className="text-cyan-500" size={40} /> Privé Voorraad</h2>
               <div className="hidden md:flex gap-4">
                  <div className="bg-white p-4 rounded-3xl border border-slate-100 shadow-sm"><span className="text-[9px] font-black text-slate-400 block uppercase">Jouw Items</span><span className="font-black">{inventory.length}</span></div>
                  <div className="bg-white p-4 rounded-3xl border border-slate-100 shadow-sm"><span className="text-[9px] font-black text-slate-400 block uppercase">Jouw Waarde</span><span className="font-black text-emerald-500">€{myStats.value}</span></div>
               </div>
            </div>
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-10">
              {inventory.map((item) => (
                <div key={item.id} className="bg-white rounded-[3.5rem] border border-slate-100 overflow-hidden hover:shadow-3xl transition-all duration-700 group flex flex-col shadow-sm">
                  <div className="h-80 relative overflow-hidden bg-slate-100">
                    {item.images?.[0] && <img src={item.images[0]} className="w-full h-full object-cover group-hover:scale-110 transition-transform duration-1000" />}
                    <div className="absolute top-8 left-8 bg-[#1A314D]/95 backdrop-blur-md px-5 py-2 rounded-2xl text-[11px] font-black text-cyan-400 shadow-xl border border-white/10 uppercase tracking-widest">{item.brand || 'PREZZOTAX'}</div>
                    <div className="absolute top-8 right-8 flex gap-2">
                      <button onClick={(e) => { e.stopPropagation(); setSelectedItem(item); setFormData(item); setIsAdding(true); setViewMode('preview'); }} className="p-4 bg-white/95 text-[#1A314D] rounded-full opacity-0 group-hover:opacity-100 hover:bg-cyan-50 transition-all shadow-2xl"><Eye size={24} /></button>
                      <button onClick={(e) => { e.stopPropagation(); deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'inventory', item.id)); }} className="p-4 bg-red-500 text-white rounded-full opacity-0 group-hover:opacity-100 hover:bg-red-600 transition-all shadow-2xl"><Trash2 size={24} /></button>
                    </div>
                  </div>
                  <div className="p-10 flex-1 flex flex-col text-left">
                    <h3 className="font-black text-2xl mb-4 line-clamp-1 italic tracking-tighter uppercase">{item.title}</h3>
                    <div className="mt-auto grid grid-cols-2 gap-4">
                      <button onClick={() => { setSelectedItem(item); setFormData(item); setIsAdding(true); setViewMode('edit'); }} className="py-4 rounded-2xl font-black text-sm bg-slate-50 text-slate-600 hover:bg-slate-200 transition-all">Aanpassen</button>
                      <button onClick={() => { setSelectedItem(item); setFormData(item); setIsAdding(true); setViewMode('preview'); }} className="py-4 rounded-2xl font-black text-sm bg-[#1A314D] text-white hover:bg-slate-800 transition-all shadow-md">Kopieer</button>
                    </div>
                  </div>
                </div>
              ))}
            </div>
          </div>
        )}

        {activeTab === 'info' && (
          <div className="space-y-16 animate-in fade-in duration-500 text-left">
             <div className="flex flex-col gap-2">
               <h2 className="text-4xl font-black flex items-center gap-5 italic text-[#1A314D] uppercase tracking-tighter">
                 <TrendingUp className="text-cyan-500" size={40} /> Markt Trends & Statistieken
               </h2>
               <div className="bg-emerald-500 text-white px-4 py-1.5 rounded-xl font-black text-[10px] uppercase w-fit tracking-widest shadow-lg italic">
                 Gegevens van het afgelopen jaar
               </div>
             </div>

             {/* Nu Trending Sectie */}
             <div className="grid grid-cols-1 md:grid-cols-2 gap-10">
                <div className="bg-[#1A314D] p-12 rounded-[4rem] text-white shadow-2xl relative overflow-hidden">
                   <Flame className="absolute -right-8 -top-8 text-cyan-500/20" size={200} />
                   <h3 className="text-3xl font-black italic uppercase mb-6 flex items-center gap-3"><Sparkles className="text-cyan-400" /> Nu Populair</h3>
                   <ul className="space-y-6 relative z-10">
                      <li className="flex items-center justify-between border-b border-white/5 pb-4"><span className="text-lg font-bold">Lentejassen</span><span className="bg-cyan-500 text-slate-900 px-3 py-1 rounded-lg font-black text-xs">+45%</span></li>
                      <li className="flex items-center justify-between border-b border-white/5 pb-4"><span className="text-lg font-bold">Y2K Streetwear</span><span className="bg-cyan-500 text-slate-900 px-3 py-1 rounded-lg font-black text-xs">+32%</span></li>
                      <li className="flex items-center justify-between border-b border-white/5 pb-4"><span className="text-lg font-bold">Designer Handtassen</span><span className="bg-emerald-500 text-white px-3 py-1 rounded-lg font-black text-xs">Piek</span></li>
                      <li className="flex items-center justify-between pb-4"><span className="text-lg font-bold">Nike Vintage</span><span className="bg-cyan-500 text-slate-900 px-3 py-1 rounded-lg font-black text-xs">+18%</span></li>
                   </ul>
                </div>

                <div className="bg-white p-12 rounded-[4rem] border border-slate-100 shadow-xl space-y-6">
                   <h3 className="text-3xl font-black italic uppercase text-[#1A314D] flex items-center gap-3"><Calendar className="text-indigo-500" /> Jaarkalender</h3>
                   <p className="text-slate-500 text-sm italic">Gemiddelde verkopen over alle Prezzotax gebruikers heen.</p>
                   <div className="h-64 overflow-y-auto space-y-4 pr-4 custom-scrollbar">
                      {seasonalTrends.map((t, idx) => (
                         <div key={idx} className="flex items-center justify-between p-4 bg-slate-50 rounded-2xl">
                            <div>
                               <div className="text-[10px] font-black text-slate-400 uppercase">{t.month}</div>
                               <div className="font-bold text-[#1A314D]">{t.items}</div>
                            </div>
                            <div className={`text-[10px] font-black uppercase px-2 py-1 rounded ${t.trend === 'Maximaal' ? 'bg-emerald-100 text-emerald-600' : 'bg-indigo-100 text-indigo-600'}`}>{t.trend}</div>
                         </div>
                      ))}
                   </div>
                </div>
             </div>

             {/* Best Practices Tabel */}
             <div className="bg-white rounded-[3rem] border border-slate-100 shadow-xl overflow-hidden">
                <div className="p-8 bg-[#1A314D] text-white flex items-center justify-between">
                   <h3 className="text-xl font-black italic uppercase tracking-widest text-cyan-400">Vinted Best Practices</h3>
                   <span className="text-[10px] font-black text-slate-400 uppercase tracking-widest">Update: Feb 2026</span>
                </div>
                <table className="w-full text-left">
                  <thead><tr className="bg-slate-50 border-b border-slate-100 text-white"><th className="p-8 font-black uppercase text-[10px] tracking-widest text-slate-400">Actie</th><th className="p-8 font-black uppercase text-[10px] tracking-widest text-slate-400">Impact</th><th className="p-8 font-black uppercase text-[10px] tracking-widest text-slate-400">Gemiddelde Groei</th></tr></thead>
                  <tbody className="divide-y divide-slate-50 font-medium">
                    <tr><td className="p-8 font-black text-[#1A314D]">Dagelijks posten</td><td className="p-8"><span className="bg-red-50 text-red-600 px-3 py-1 rounded-lg font-black text-[10px] uppercase">Zeer Hoog</span></td><td className="p-8 text-slate-500">+120% weergaven</td></tr>
                    <tr><td className="p-8 font-black text-[#1A314D]">Internationale verzending</td><td className="p-8"><span className="bg-emerald-50 text-emerald-600 px-3 py-1 rounded-lg font-black text-[10px] uppercase">Maximaal</span></td><td className="p-8 text-slate-500">+300% potentiële kopers</td></tr>
                    <tr><td className="p-8 font-black text-[#1A314D]">Bumper-uren (19u-21u)</td><td className="p-8"><span className="bg-indigo-50 text-indigo-600 px-3 py-1 rounded-lg font-black text-[10px] uppercase">Hoog</span></td><td className="p-8 text-slate-500">+45% snellere verkoop</td></tr>
                  </tbody>
                </table>
             </div>
          </div>
        )}

        {activeTab === 'community' && (
          <div className="space-y-10 animate-in fade-in duration-500 flex flex-col h-[75vh]">
            <div className="flex flex-col md:flex-row items-center justify-between gap-6 shrink-0">
              <h2 className="text-4xl font-black italic text-[#1A314D] uppercase shrink-0 tracking-tighter">Community</h2>
              <div className="flex bg-white p-2 rounded-[2rem] border border-slate-100 shadow-sm flex-1 max-w-md w-full">
                 <button onClick={() => setCommunityTab('chat')} className={`flex-1 py-3 rounded-[1.5rem] font-black text-[10px] uppercase tracking-widest transition-all ${communityTab === 'chat' ? 'bg-[#1A314D] text-white' : 'text-slate-400'}`}>Algemene Chat</button>
                 <button onClick={() => setCommunityTab('belangrijk')} className={`flex-1 py-3 rounded-[1.5rem] font-black text-[10px] uppercase tracking-widest transition-all ${communityTab === 'belangrijk' ? 'bg-[#00B4D8] text-white shadow-lg' : 'text-slate-400'}`}>Vragen & FAQ</button>
              </div>
            </div>

            <div className="flex-1 bg-white rounded-[4rem] border border-slate-100 shadow-2xl overflow-hidden flex flex-col">
               <div className="flex-1 overflow-y-auto p-10 space-y-8 bg-slate-50/30">
                  {messages.filter(m => communityTab === 'belangrijk' ? m.isImportant : !m.isImportant).map((msg) => (
                    <div key={msg.id} className={`flex flex-col ${msg.userId === user?.uid ? 'items-end' : 'items-start'}`}>
                       <span className="text-[9px] font-black text-slate-300 uppercase mb-3 px-2">{msg.userName || "User"}</span>
                       <div className={`max-w-[85%] p-7 rounded-[2.5rem] shadow-sm relative text-left ${msg.userId === user?.uid ? 'bg-[#1A314D] text-white rounded-tr-none' : 'bg-white text-slate-700 rounded-tl-none border border-slate-100'}`}>
                          {msg.isImportant && <Star size={16} className="text-cyan-400 mb-3 fill-current absolute -top-2 -left-2 drop-shadow-md" />}
                          <p className="font-medium text-base leading-relaxed">{msg.text}</p>
                       </div>
                    </div>
                  ))}
               </div>
               <div className="p-8 bg-white border-t border-slate-50 flex gap-4">
                  <input value={newMessage} onChange={(e) => setNewMessage(e.target.value)} onKeyDown={(e) => e.key === 'Enter' && sendMessage(communityTab === 'belangrijk')} placeholder={communityTab === 'belangrijk' ? "Stel een open vraag aan iedereen..." : "Praat mee..."} className="flex-1 bg-slate-50 border-none rounded-[2rem] px-8 py-5 font-bold text-slate-900 focus:ring-4 focus:ring-cyan-100 shadow-inner" />
                  <button onClick={() => sendMessage(communityTab === 'belangrijk')} className="w-16 h-16 rounded-full bg-[#1A314D] flex items-center justify-center text-cyan-400 shadow-xl active:scale-90 transition-all shrink-0 hover:bg-slate-800"><Send size={24} /></button>
               </div>
            </div>
          </div>
        )}
      </main>

      {/* Editor Modal */}
      {isAdding && (
        <div className="fixed inset-0 bg-[#1A314D]/95 backdrop-blur-3xl z-50 flex items-center justify-center p-4">
          <div className="bg-white w-full max-w-6xl rounded-[4.5rem] overflow-hidden shadow-2xl flex flex-col max-h-[95vh] animate-in zoom-in-95 duration-500 relative">
            <button onClick={() => setIsAdding(false)} className="absolute top-12 right-12 bg-slate-100 p-5 rounded-full hover:bg-slate-200 transition-colors text-slate-900"><X size={32} /></button>
            <div className="p-16 pb-10 flex items-center gap-10 border-b border-slate-50">
              <button onClick={() => setViewMode('edit')} className={`text-4xl font-black tracking-tight transition-all ${viewMode === 'edit' ? 'text-[#1A314D] underline decoration-cyan-400 decoration-4 underline-offset-8' : 'text-slate-300'}`}>Formulier</button>
              <button onClick={() => setViewMode('preview')} className={`text-4xl font-black tracking-tight transition-all ${viewMode === 'preview' ? 'text-[#1A314D] underline decoration-cyan-400 decoration-4 underline-offset-8' : 'text-slate-300'}`}>Vinted Preview</button>
            </div>
            <div className="p-16 overflow-y-auto space-y-16">
              {viewMode === 'edit' ? (
                <div className="space-y-16 pb-10 text-left">
                  <div className="space-y-8 text-center"><h4 className="text-[12px] font-black uppercase text-slate-300 tracking-[0.2em]">Galerij</h4><div className="grid grid-cols-2 sm:grid-cols-5 gap-6">{formData.images.map((img, idx) => (<div key={idx} className="aspect-square rounded-[2.5rem] overflow-hidden relative border-2 border-slate-100 shadow-sm"><img src={img} className="w-full h-full object-cover" /><button onClick={() => removeImage(idx)} className="absolute top-4 right-4 p-2 bg-white/90 text-red-500 rounded-xl shadow-lg"><X size={16} /></button></div>))}{formData.images.length < 10 && (<button onClick={() => fileInputRef.current.click()} className="aspect-square rounded-[2.5rem] border-4 border-dashed border-slate-100 flex flex-col items-center justify-center text-slate-300 hover:border-cyan-400 transition-all hover:bg-cyan-50/20"><Camera size={48} /></button>)}</div><input type="file" ref={fileInputRef} onChange={handleImageChange} accept="image/*" multiple className="hidden" />{loading && (<div className="bg-[#1A314D] rounded-[3rem] p-12 flex flex-col items-center justify-center gap-8 shadow-2xl animate-pulse"><Loader2 className="animate-spin text-cyan-400" size={80} /><div className="font-black text-cyan-400 uppercase tracking-[0.4em] text-center italic">Prezzotax Scant...</div></div>)}</div>
                  <div className="space-y-12">
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-10">
                      <div className="space-y-4"><label className="text-[11px] font-black uppercase text-slate-400 ml-4 tracking-widest italic leading-none">Titel (incl. Maat)</label><input type="text" value={formData.title} onChange={(e) => setFormData({...formData, title: e.target.value})} className="w-full px-8 py-6 rounded-[2rem] bg-slate-50 border-none font-black text-xl italic focus:ring-4 focus:ring-cyan-100 transition-all shadow-inner" /></div>
                      <div className="space-y-4"><label className="text-[11px] font-black uppercase text-slate-400 ml-4 tracking-widest italic leading-none">Merk</label><input type="text" value={formData.brand} placeholder="VINTED PRO" onChange={(e) => setFormData({...formData, brand: e.target.value})} className="w-full px-8 py-6 rounded-[2rem] bg-slate-50 border-none font-black text-xl italic focus:ring-4 focus:ring-cyan-100 transition-all shadow-inner" /></div>
                    </div>
                    <div className="grid grid-cols-2 md:grid-cols-4 gap-6 text-center">
                      {['size', 'color', 'material', 'targetPrice'].map((key) => (<div key={key} className="space-y-4"><label className="text-[11px] font-black uppercase text-slate-400 tracking-widest uppercase italic leading-none">{key === 'targetPrice' ? 'Prijs (€)' : key.toUpperCase()}</label><input type="text" value={formData[key]} onChange={(e) => setFormData({...formData, [key]: e.target.value})} className={`w-full px-8 py-6 rounded-[2rem] bg-slate-50 border-none font-black text-center italic ${key === 'targetPrice' ? 'text-emerald-600 bg-emerald-50 shadow-sm' : ''}`} /></div>))}
                    </div>
                    <div className="space-y-4"><label className="text-[11px] font-black uppercase text-slate-400 ml-4 tracking-widest italic uppercase leading-none">Hashtags</label><input type="text" value={formData.hashtags} onChange={(e) => setFormData({...formData, hashtags: e.target.value})} className="w-full px-8 py-6 rounded-[2rem] bg-[#1A314D] border-none font-bold text-cyan-400 shadow-2xl focus:ring-4 focus:ring-cyan-500/20" /></div>
                    <div className="grid grid-cols-1 gap-12 text-slate-900">
                      <div className="space-y-4"><label className="text-[11px] font-black uppercase text-slate-400 ml-4 italic uppercase text-left block leading-none">Nederlands</label><textarea rows="4" value={formData.description_nl} onChange={(e) => setFormData({...formData, description_nl: e.target.value})} className="w-full px-10 py-8 rounded-[3rem] bg-slate-50 border-none font-medium leading-relaxed shadow-inner" /></div>
                      <div className="space-y-4"><label className="text-[11px] font-black uppercase text-indigo-400 ml-4 italic uppercase text-left block leading-none">English</label><textarea rows="4" value={formData.description_en} onChange={(e) => setFormData({...formData, description_en: e.target.value})} className="w-full px-10 py-8 rounded-[3rem] bg-indigo-50/30 border-none font-medium leading-relaxed shadow-inner" /></div>
                      <div className="space-y-4"><label className="text-[11px] font-black uppercase text-emerald-400 ml-4 italic uppercase text-left block leading-none">Français</label><textarea rows="4" value={formData.description_fr} onChange={(e) => setFormData({...formData, description_fr: e.target.value})} className="w-full px-10 py-8 rounded-[3rem] bg-emerald-50/30 border-none font-medium leading-relaxed shadow-inner" /></div>
                    </div>
                  </div>
                </div>
              ) : (
                <div className="grid grid-cols-1 lg:grid-cols-2 gap-16 animate-in fade-in duration-500 pb-10 text-left">
                  <div className="space-y-8 lg:sticky lg:top-0 h-fit">
                    <div className="aspect-[4/5] rounded-[4rem] overflow-hidden bg-slate-100 shadow-3xl relative border border-slate-100">{formData.images?.[0] && <img src={formData.images[0]} className="w-full h-full object-cover" />}<div className="absolute top-8 left-8 shadow-2xl ring-4 ring-white/30 rounded-full"><PrezzotaxLogo size={64} showText={false} /></div></div>
                    <div className="bg-white p-10 rounded-[3.5rem] border border-slate-50 shadow-sm space-y-6 text-left">
                       <div className="flex justify-between items-start">
                         <h3 className="text-3xl font-black text-[#1A314D] italic uppercase tracking-tighter leading-none pr-6">{formData.title}</h3>
                         <button onClick={() => copyText(formData.title)} className="bg-slate-100 p-4 rounded-3xl hover:bg-slate-200 text-slate-500 transition-all shrink-0"><Copy size={24} /></button>
                       </div>
                       <div className="text-5xl font-black text-cyan-600 tracking-tighter italic leading-none">€{formData.targetPrice}</div>
                    </div>
                  </div>
                  <div className="space-y-12">
                    <div className="bg-[#1A314D] p-12 rounded-[4rem] relative shadow-2xl border border-slate-800">
                      <div className="flex justify-between items-center mb-10">
                        <div className="flex items-center gap-3 text-left">
                           <PrezzotaxLogo size={48} showText={false} />
                           <h5 className="font-black text-slate-300 text-[11px] uppercase tracking-[0.3em] italic leading-none">Prezzo V5.1 Secure</h5>
                        </div>
                        <button onClick={() => copyText(getFullDescription())} className="bg-[#00B4D8] text-white px-8 py-4 rounded-2xl font-black text-xs uppercase tracking-widest shadow-xl transition-all active:scale-95 hover:bg-cyan-500 italic">Kopieer Alles</button>
                      </div>
                      <textarea readOnly value={getFullDescription()} className="w-full h-[550px] bg-slate-800/40 border-none rounded-[2.5rem] p-10 text-slate-200 font-medium text-lg leading-relaxed resize-none focus:ring-0 scrollbar-hide shadow-inner" />
                    </div>
                  </div>
                </div>
              )}
            </div>
            <div className="p-16 bg-slate-50 border-t border-slate-100 flex gap-8 shrink-0"><button onClick={handleSave} disabled={formData.images.length === 0 || saveStatus === 'saving'} className="flex-[2] bg-[#1A314D] text-white font-black py-8 rounded-[3rem] flex items-center justify-center gap-5 transition-all shadow-3xl active:scale-95 text-2xl group"><Save size={32} className="text-cyan-400 group-hover:scale-125 transition-transform" /> <span>Beveiligen in Magazijn</span></button></div>
          </div>
        </div>
      )}

      {/* Navigatie */}
      <nav className="fixed bottom-10 left-1/2 -translate-x-1/2 bg-[#1A314D]/95 backdrop-blur-3xl px-10 py-6 rounded-[3rem] flex items-center gap-10 sm:gap-16 z-50 shadow-[0_40px_80px_-20px_rgba(0,0,0,0.6)] border border-white/5">
        <button onClick={() => setActiveTab('overzicht')} className={`flex flex-col items-center gap-1.5 transition-all ${activeTab === 'overzicht' ? 'text-cyan-400 scale-125' : 'text-slate-500 hover:text-slate-300'}`}><Layout size={26} /><span className="text-[7px] font-black uppercase tracking-widest leading-none">Home</span></button>
        <button onClick={() => setActiveTab('magazijn')} className={`flex flex-col items-center gap-1.5 transition-all ${activeTab === 'magazijn' ? 'text-cyan-400 scale-125' : 'text-slate-500 hover:text-slate-300'}`}><Package size={26} /><span className="text-[7px] font-black uppercase tracking-widest leading-none">Kast</span></button>
        <button onClick={() => setActiveTab('community')} className={`flex flex-col items-center gap-1.5 transition-all ${activeTab === 'community' ? 'text-cyan-400 scale-125' : 'text-slate-500 hover:text-slate-300'}`}><MessageSquare size={26} /><span className="text-[7px] font-black uppercase tracking-widest leading-none">Forum</span></button>
        <button onClick={() => setActiveTab('info')} className={`flex flex-col items-center gap-1.5 transition-all ${activeTab === 'info' ? 'text-cyan-400 scale-125' : 'text-slate-500 hover:text-slate-300'}`}><TrendingUp size={26} /><span className="text-[7px] font-black uppercase tracking-widest leading-none">Trends</span></button>
      </nav>
    </div>
  );
};

export default App;
